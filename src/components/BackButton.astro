---
import IconChevronLeft from "@/assets/icons/IconChevronLeft.svg";
import LinkButton from "./LinkButton.astro";
import { SITE } from "@/config";
---

{
  SITE.showBackButton && (
    <div class="mx-auto flex w-full max-w-app items-center justify-start px-2">
      <LinkButton
        id="back-button"
        href={import.meta.env.BASE_URL}
        class="focus-outline mt-8 mb-2 flex hover:text-foreground/75"
      >
        <IconChevronLeft class="inline-block size-6 rtl:rotate-180" />
        <span>Go back</span>
      </LinkButton>
    </div>
  )
}

<script>
  /* Update Go Back URL with proper base path handling */
  function updateGoBackUrl() {
    const backButton: HTMLAnchorElement | null =
      document.querySelector("#back-button");

    if (!backButton) return;

    const storedBackUrl = sessionStorage.getItem("backUrl");
    
    if (storedBackUrl) {
      // If we have a stored URL, use it (it should already include base path)
      backButton.href = storedBackUrl;
    } else {
      // If no stored URL, try to determine from document.referrer
      const referrer = document.referrer;
      const baseUrl = import.meta.env.BASE_URL;
      const currentOrigin = window.location.origin;
      
      if (referrer && referrer.startsWith(currentOrigin)) {
        // Extract the path from referrer and check if it already has base path
        const referrerPath = new URL(referrer).pathname;
        
        if (referrerPath.startsWith(baseUrl.replace(/\/$/, ''))) {
          // Referrer already has correct base path
          backButton.href = referrer;
        } else {
          // Referrer needs base path correction (shouldn't happen in normal cases)
          backButton.href = baseUrl;
        }
      } else {
        // No referrer or external referrer, use base URL
        backButton.href = baseUrl;
      }
    }
  }

  document.addEventListener("astro:page-load", updateGoBackUrl);
  updateGoBackUrl();
</script>
